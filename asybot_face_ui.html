<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Asybot UI - Speech Recognition</title>
    <style>
        body { margin: 0; padding: 0; display: flex; justify-content: center; align-items: center; height: 100vh; background-color: #121212; overflow: hidden; color: #ccc; font-family: monospace; }
        .prompt { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 24px; text-align: center; }
        #transcript-display { position: absolute; top: 20px; left: 20px; right: 20px; text-align: center; font-size: 28px; color: #fff; background-color: rgba(0,0,0,0.3); padding: 10px; border-radius: 8px; min-height: 40px; }
    </style>
</head>
<body>
    <div id="start-prompt" class="prompt">Klik untuk memulai...</div>
    <div id="transcript-display"></div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.9.0/p5.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.9.0/addons/p5.sound.min.js"></script>

    <script>
        // --- MODUL 1: API KONTROL WAJAH (Tidak Berubah) ---
        const AsybotFace = {
            state: 'NEUTRAL', lerpFactor: 0.1, bounceFactor: 0, current: { eyeSize: 0, mouthWidth: 0, mouthHeight: 0 }, target: { eyeSize: 0, mouthWidth: 0, mouthHeight: 0 }, init: function() { this.setExpression(this.state, true); }, setExpression: function(newState, immediate = false) { if (this.state === newState && !immediate) return; this.state = newState; console.log("API CALL: setExpression('" + newState + "')"); switch (this.state) { case 'HAPPY': this.target.eyeSize = width / 14; this.target.mouthWidth = width / 6; this.target.mouthHeight = height / 10; break; case 'SURPRISED': this.target.eyeSize = width / 12; this.target.mouthWidth = width / 12; this.target.mouthHeight = height / 8; break; case 'THINKING': this.target.eyeSize = width / 18; this.target.mouthWidth = width / 7; this.target.mouthHeight = 5; break; default: this.target.eyeSize = width / 15; this.target.mouthWidth = width / 8; this.target.mouthHeight = height / 15; break; } if (immediate) { this.current = {...this.target}; } }, update: function() { this.bounceFactor = sin(frameCount * 0.05) * 5; this.current.eyeSize = lerp(this.current.eyeSize, this.target.eyeSize, this.lerpFactor); this.current.mouthWidth = lerp(this.current.mouthWidth, this.target.mouthWidth, this.lerpFactor); this.current.mouthHeight = lerp(this.current.mouthHeight, this.target.mouthHeight, this.lerpFactor); }, draw: function() { let eyeY = height / 2 - height / 10; fill(255); noStroke(); ellipse(width / 2 - width / 10, eyeY + this.bounceFactor, this.current.eyeSize, this.current.eyeSize); ellipse(width / 2 + width / 10, eyeY + this.bounceFactor, this.current.eyeSize, this.current.eyeSize); let mouthY = height / 2 + height / 12; stroke(255); strokeWeight(10); switch (this.state) { case 'SURPRISED': fill(18, 18, 18); ellipse(width / 2, mouthY + this.current.mouthHeight / 2, this.current.mouthWidth, this.current.mouthHeight); break; case 'THINKING': noFill(); let wiggle = sin(frameCount * 0.2) * 5; line(width / 2 - this.current.mouthWidth / 2, mouthY + wiggle, width / 2 + this.current.mouthWidth / 2, mouthY + wiggle); break; default: noFill(); arc(width / 2, mouthY, this.current.mouthWidth, this.current.mouthHeight + this.bounceFactor, 0, PI); break; }}
        };

        // --- MODUL 3: SPEECH-TO-TEXT ENGINE ---
        const AsybotSTT = {
            recognition: null,
            isRecognizing: false,
            transcriptDisplay: null,

            init: function() {
                this.transcriptDisplay = document.getElementById('transcript-display');
                // Pengecekan kompatibilitas browser
                window.SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                if (!window.SpeechRecognition) {
                    console.error("Browser tidak mendukung Web Speech API.");
                    this.transcriptDisplay.innerText = "Browser Anda tidak mendukung Speech-to-Text.";
                    return;
                }
                
                this.recognition = new SpeechRecognition();
                this.recognition.continuous = true; // Terus mendengarkan
                this.recognition.interimResults = true; // Tampilkan hasil sementara
                this.recognition.lang = 'id-ID'; // Set bahasa ke Indonesia

                this.recognition.onstart = () => {
                    this.isRecognizing = true;
                    AsybotFace.setExpression('THINKING');
                    console.log("STT: Mulai mendengarkan...");
                };

                this.recognition.onend = () => {
                    this.isRecognizing = false;
                    AsybotFace.setExpression('NEUTRAL');
                    console.log("STT: Berhenti mendengarkan.");
                };

                this.recognition.onresult = (event) => {
                    let interim_transcript = '';
                    let final_transcript = '';

                    for (let i = event.resultIndex; i < event.results.length; ++i) {
                        if (event.results[i].isFinal) {
                            final_transcript += event.results[i][0].transcript;
                        } else {
                            interim_transcript += event.results[i][0].transcript;
                        }
                    }
                    this.transcriptDisplay.innerText = final_transcript + interim_transcript;
                    if (final_transcript) {
                        console.log("Final Transcript:", final_transcript);
                        // Di sini kita akan memproses final_transcript nanti
                    }
                };

                this.recognition.onerror = (event) => {
                    console.error("STT Error:", event.error);
                };
            },

            start: function() {
                if (this.recognition && !this.isRecognizing) {
                    this.transcriptDisplay.innerText = "";
                    this.recognition.start();
                }
            },

            stop: function() {
                if (this.recognition && this.isRecognizing) {
                    this.recognition.stop();
                }
            }
        };

        // --- MODUL 2: API PEMROSESAN AUDIO (DIPERBARUI) ---
        const AsybotAudio = {
            mic: null, isListening: false, currentLevel: 0, smoothing: 0.1,
            listeningThreshold: 0.02, isSoundDetected: false, soundStopDelay: 1500, soundStopTimer: null,

            init: function() { /* ... kode init audio tidak berubah ... */ this.mic = new p5.AudioIn(); this.mic.start(() => { console.log("Microphone activated."); this.isListening = true; document.getElementById('start-prompt').style.display = 'none'; }, (err) => { console.error("Microphone access denied or failed:", err); document.getElementById('start-prompt').innerText = 'Error: Gagal mengakses mikrofon.'; }); },
            update: function() {
                if (!this.isListening) return;
                this.currentLevel = lerp(this.currentLevel, this.mic.getLevel(), this.smoothing);

                if (this.currentLevel > this.listeningThreshold) {
                    if (!this.isSoundDetected) {
                        this.isSoundDetected = true;
                        AsybotSTT.start(); // MEMULAI STT
                    }
                    clearTimeout(this.soundStopTimer);
                } else if (this.isSoundDetected) {
                    this.soundStopTimer = setTimeout(() => {
                        this.isSoundDetected = false;
                        AsybotSTT.stop(); // MENGHENTIKAN STT
                    }, this.soundStopDelay);
                }
            },
            drawDebugVisualizer: function() { /* ... kode visualizer tidak berubah ... */ if (!this.isListening) return; let vizDiameter = map(this.currentLevel, 0, 1, 50, 400); fill(255, 50); noStroke(); circle(width / 2, height - 150, vizDiameter); let thresholdY = map(this.listeningThreshold, 0, 1, 50, 400); stroke(255, 0, 0, 150); strokeWeight(2); line(width/2 - 200, height - 150 - thresholdY/2, width/2 + 200, height - 150 - thresholdY/2); }
        };
        
        // --- DRIVER UTAMA APLIKASI ---
        let audioStarted = false;
        function setup() { createCanvas(windowWidth, windowHeight); ellipseMode(CENTER); AsybotFace.init(); AsybotSTT.init(); }
        function draw() { background("#121212"); AsybotFace.update(); AsybotFace.draw(); if (audioStarted) { AsybotAudio.update(); AsybotAudio.drawDebugVisualizer(); } }
        function mousePressed() { if (!audioStarted) { userStartAudio(); AsybotAudio.init(); audioStarted = true; } }
        function windowResized() { resizeCanvas(windowWidth, windowHeight); AsybotFace.setExpression(AsybotFace.state, true); }
    </script>
</body>
</html>

