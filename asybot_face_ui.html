<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Asybot UI - WebSocket Client</title>
    <style>
        body { margin: 0; padding: 0; display: flex; justify-content: center; align-items: center; height: 100vh; background-color: #121212; overflow: hidden; color: #ccc; font-family: monospace; }
        #status-indicator { position: absolute; bottom: 20px; left: 50%; transform: translateX(-50%); font-size: 18px; color: #888; }
    </style>
</head>
<body>
    <div id="status-indicator">STATUS: CONNECTING...</div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.9.0/p5.min.js"></script>
    <script>
        // --- MODUL 1: API KONTROL WAJAH (Tidak berubah signifikan) ---
        const AsybotFace = {
            state: 'NEUTRAL', viseme: 'default', lerpFactor: 0.2, bounceFactor: 0,
            current: { eyeSize: 0, mouthWidth: 0, mouthHeight: 0 },
            target: { eyeSize: 0, mouthWidth: 0, mouthHeight: 0 },
            init: function() { this.setExpression(this.state, true); },
            setExpression: function(newState, immediate = false) { if (this.state === newState && !immediate) return; this.state = newState; console.log("API CALL: setExpression('" + newState + "')"); switch (this.state) { case 'HAPPY': this.target.eyeSize = width / 14; this.target.mouthWidth = width / 6; this.target.mouthHeight = height / 10; break; case 'SURPRISED': this.target.eyeSize = width / 12; this.target.mouthWidth = width / 12; this.target.mouthHeight = height / 8; break; case 'THINKING': this.target.eyeSize = width / 18; this.target.mouthWidth = width / 7; this.target.mouthHeight = 5; break; default: this.target.eyeSize = width / 15; this.target.mouthWidth = width / 8; this.target.mouthHeight = height / 15; break; } if (immediate) { this.current = {...this.target}; } },
            setViseme: function(vowel) { this.viseme = vowel || 'default'; },
            update: function() { this.bounceFactor = sin(frameCount * 0.05) * 5; this.current.eyeSize = lerp(this.current.eyeSize, this.target.eyeSize, this.lerpFactor); if (this.viseme === 'default') { this.current.mouthWidth = lerp(this.current.mouthWidth, this.target.mouthWidth, this.lerpFactor); this.current.mouthHeight = lerp(this.current.mouthHeight, this.target.mouthHeight, this.lerpFactor); } else { let visemeTarget = this.getVisemeTarget(); this.current.mouthWidth = lerp(this.current.mouthWidth, visemeTarget.w, 0.5); this.current.mouthHeight = lerp(this.current.mouthHeight, visemeTarget.h, 0.5); } },
            getVisemeTarget: function() { switch (this.viseme) { case 'a': return { w: width / 7, h: height / 9 }; case 'i': return { w: width / 5, h: 5 }; case 'u': return { w: width / 14, h: height / 12 }; case 'e': return { w: width / 6, h: height / 11 }; case 'o': return { w: width / 8, h: height / 8 }; default: return { w: this.target.mouthWidth, h: this.target.mouthHeight }; } },
            draw: function() {
                background("#121212");
                let eyeY = height / 2 - height / 10; fill(255); noStroke(); ellipse(width / 2 - width / 10, eyeY + this.bounceFactor, this.current.eyeSize, this.current.eyeSize); ellipse(width / 2 + width / 10, eyeY + this.bounceFactor, this.current.eyeSize, this.current.eyeSize);
                let mouthY = height / 2 + height / 12;
                stroke(255); strokeWeight(10); noFill();
                if (this.viseme !== 'default') {
                    fill(18,18,18);
                    ellipse(width / 2, mouthY + this.current.mouthHeight/2, this.current.mouthWidth, this.current.mouthHeight);
                } else {
                    switch (this.state) { case 'SURPRISED': fill(18, 18, 18); ellipse(width / 2, mouthY + this.current.mouthHeight / 2, this.current.mouthWidth, this.current.mouthHeight); break; case 'THINKING': let wiggle = sin(frameCount * 0.2) * 5; line(width / 2 - this.current.mouthWidth / 2, mouthY + wiggle, width / 2 + this.current.mouthWidth / 2, mouthY + wiggle); break; default: arc(width / 2, mouthY, this.current.mouthWidth, this.current.mouthHeight + this.bounceFactor, 0, PI); break; }
                }
            }
        };

        // --- MODUL TTS (Sedikit berubah) ---
        const AsybotTTS = {
            isSpeaking: false,
            init: function() { /* Inisialisasi tidak diperlukan lagi di sini */ },
            findVowelInWord: function(word) { const vowels = ['a', 'i', 'u', 'e', 'o']; for (let char of word.toLowerCase()) { if (vowels.includes(char)) return char; } return 'a'; },
            speak: function(text) {
                if (this.isSpeaking) return;
                const utterance = new SpeechSynthesisUtterance(text);
                utterance.lang = 'id-ID';
                utterance.onstart = () => { this.isSpeaking = true; UIManager.updateStatus('SPEAKING'); };
                utterance.onboundary = (event) => { if (event.name === 'word') { const word = text.substring(event.charIndex, text.indexOf(' ', event.charIndex)); const vowel = this.findVowelInWord(word); AsybotFace.setViseme(vowel); } };
                utterance.onend = () => { this.isSpeaking = false; AsybotFace.setViseme('default'); UIManager.updateStatus('CONNECTED'); };
                window.speechSynthesis.speak(utterance);
            }
        };
        
        // --- MODUL UI MANAGER (Sedikit berubah) ---
        const UIManager = {
            statusIndicator: null,
            init: function() { this.statusIndicator = document.getElementById('status-indicator'); },
            updateStatus: function(status) { this.statusIndicator.innerText = `STATUS: ${status}`; },
        };

        // --- MODUL BARU: WEBSOCKET CLIENT ---
        const AsybotSocketClient = {
            socket: null,
            init: function() {
                // Ganti 'localhost' dengan alamat IP Jetson saat implementasi
                const serverAddress = "ws://localhost:8765";
                this.socket = new WebSocket(serverAddress);

                this.socket.onopen = (event) => {
                    console.log("CLIENT: Terhubung ke server WebSocket.");
                    UIManager.updateStatus("CONNECTED");
                };

                this.socket.onmessage = (event) => {
                    console.log(`CLIENT < Menerima pesan: ${event.data}`);
                    const data = JSON.parse(event.data);
                    this.handleCommand(data);
                };

                this.socket.onclose = (event) => {
                    console.log("CLIENT: Koneksi ke server terputus.");
                    UIManager.updateStatus("DISCONNECTED");
                };

                this.socket.onerror = (error) => {
                    console.error("CLIENT: WebSocket Error:", error);
                    UIManager.updateStatus("ERROR");
                };
            },
            handleCommand: function(data) {
                if (!data.command || !data.hasOwnProperty('value')) return;
                switch(data.command) {
                    case "setExpression":
                        AsybotFace.setExpression(data.value);
                        break;
                    case "speak":
                        AsybotTTS.speak(data.value);
                        break;
                    // Tambahkan perintah lain di sini di masa depan
                }
            }
        };

        // --- DRIVER UTAMA APLIKASI ---
        function setup() {
            createCanvas(windowWidth, windowHeight);
            ellipseMode(CENTER);
            AsybotFace.init();
            UIManager.init();
            AsybotSocketClient.init();
        }
        function draw() {
            AsybotFace.update();
            AsybotFace.draw();
        }
        function windowResized() {
            resizeCanvas(windowWidth, windowHeight);
            AsybotFace.setExpression(AsybotFace.state, true);
        }
    </script>
</body>
</html>

